{
  "variables": {
    "nixos_version": "17.03.1203.58e227052d",
    "nixos_checksum": "b130b1b804f4f9e3ef71dfa216bc474e6ef289fb8bef8fc861e92e0273ac5e8b",
    "atlas_token": "{{env `ATLAS_TOKEN`}}"
  },
  "builders": [
    {
      "vm_name": "nixos64",
      "type": "virtualbox-iso",
      "iso_url": "https://d3g5gsiof5omrk.cloudfront.net/nixos/17.03/nixos-{{user `nixos_version`}}/nixos-minimal-{{user `nixos_version`}}-x86_64-linux.iso",
      "iso_checksum": "{{user `nixos_checksum`}}",
      "iso_checksum_type": "sha256",
      "guest_os_type": "Linux_64",
      "boot_command": [
        "<enter><wait10><wait10><wait10><wait10>",
        "echo \"- - L *\" > /root/sda.layout", "<enter>",
        "sfdisk /dev/sda < /root/sda.layout", "<enter>",
        "mkfs.ext4 -L nixos /dev/sda1", "<enter><wait10><wait10>",
        "mount /dev/disk/by-label/nixos /mnt", "<enter>",
        "mkdir -p /mnt/etc/nixos", "<enter>",
        "nixos-generate-config --root /mnt", "<enter>",
        "curl -o /mnt/etc/nixos/configuration.nix http://{{ .HTTPIP }}:{{ .HTTPPort }}/configuration.nix && ",
        "nixos-install && ",
        "reboot", "<enter>"
      ],
      "boot_wait": "3s",
      "disk_size": 40000,
      "http_directory": ".",
      "ssh_username": "vagrant",
      "ssh_password": "vagrant",
      "shutdown_command": "sudo -S shutdown -P now",
      "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--memory", "1024"],
        ["modifyvm", "{{.Name}}", "--cpus", "1"]
      ]
    }
  ],
  "post-processors": [
    [
    {
      "type": "vagrant",
      "vagrantfile_template": "Vagrantfile.tpl",
      "output": "{{.Provider}}/nixos64.box"
    },
    {
      "type": "atlas",
      "token": "{{user `atlas_token`}}",
      "artifact": "griff/nixos64",
      "artifact_type": "vagrant.box",
      "metadata": {
        "provider": "virtualbox",
        "created_at": "{{timestamp}}"
      }
    }
    ]
  ]
}
